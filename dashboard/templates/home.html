{% extends 'base.html' %} {# Verifique se este caminho encontra o seu base.html #}
{% load static %}

{% block title %}Dashboard - Análises e Estatísticas{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold fs-4 mb-0">
            <i class="bi bi-bar-chart-line-fill me-2 text-primary"></i>
            Análises e Estatísticas
        </h2>
        {# Dropdown principal movido para baixo do gráfico #}
    </div>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Website</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-muted" href="#">Eventos</a>
        </li>
    </ul>

    <div class="row g-4 mb-4">
        <div class="col-lg-4 col-md-6">
            <div onclick="showChart('ativos')" class="card border-0 shadow-sm h-100" style="border-radius: 0.75rem; cursor:pointer; transition: box-shadow 0.2s ease;">
                <div class="card-body p-3"> <div class="d-flex align-items-center gap-3"> <div style="width: 45px; height: 45px; border-radius: 50%; background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; flex-shrink: 0;"> <i class="bi bi-person-fill"></i> </div> <div> <p class="mb-0 small text-muted">Utilizadores Ativos</p> <h5 class="mb-0 fw-bold" id="total-active-value">{{ total_active }}</h5> </div> </div> </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
             <div onclick="showChart('eventos')" class="card border-0 shadow-sm h-100" style="border-radius: 0.75rem; cursor:pointer; transition: box-shadow 0.2s ease;">
                 <div class="card-body p-3"> <div class="d-flex align-items-center gap-3"> <div style="width: 45px; height: 45px; border-radius: 50%; background-color: rgba(255, 193, 7, 0.15); color: #ffc107; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; flex-shrink: 0;"> <i class="bi bi-calendar-event-fill"></i> </div> <div> <p class="mb-0 small text-muted">Eventos</p> <h5 class="mb-0 fw-bold" id="total-events-value">{{ total_events }}</h5> </div> </div> </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12">
             <div onclick="showChart('novos')" class="card border-0 shadow-sm h-100" style="border-radius: 0.75rem; cursor:pointer; transition: box-shadow 0.2s ease;">
                 <div class="card-body p-3"> <div class="d-flex align-items-center gap-3"> <div style="width: 45px; height: 45px; border-radius: 50%; background-color: rgba(40, 167, 69, 0.1); color: #28a745; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; flex-shrink: 0;"> <i class="bi bi-person-plus-fill"></i> </div> <div> <p class="mb-0 small text-muted">Utilizadores Novos</p> <h5 class="mb-0 fw-bold" id="total-new-value">{{ total_new }}</h5> </div> </div> </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm" style="border-radius: 0.75rem;">
         <div class="card-header bg-white border-0 pt-3 pb-0 px-3">
             <h5 class="card-title fw-semibold mb-0 fs-6" id="chartTitle">Utilizadores Ativos</h5>
         </div>
        <div class="card-body chart-container p-2"> {# Controlado por CSS externo #}
            <canvas id="mainLineChart"></canvas>
        </div>
    </div>

    <div class="dropdown mt-3 mb-4"> {# Dropdown principal movido para aqui #}
      <button class="btn btn-outline-secondary dropdown-toggle btn-sm period-dropdown-button" type="button" id="periodDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        {{ selected_period_label }}
      </button>
      <ul class="dropdown-menu" aria-labelledby="periodDropdown">
        {% for key, period_data in allowed_periods.items %}
          <li>
            {# Links agora usam JS, href="#" e data-period-key #}
            <a class="dropdown-item period-link {% if key == selected_period_key %}active{% endif %}"
                href="#"
                data-period-key="{{ key }}">
                {{ period_data.label }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="row g-4"> {# Linha inferior #}
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 0.75rem;">
                <div class="card-header bg-white border-0 pt-3 pb-0 px-3 d-flex justify-content-between align-items-center"> <h5 class="card-title fw-semibold mb-0 fs-6">Visualizações por Título</h5> <div class="dropdown d-inline-block"> <button class="btn btn-sm btn-outline-secondary dropdown-toggle period-dropdown-button" type="button" id="pageViewsPeriodDropdown" data-bs-toggle="dropdown" aria-expanded="false"> {{ selected_period_label }} </button> <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="pageViewsPeriodDropdown"> {% for key, period_data in allowed_periods.items %}<li><a class="dropdown-item period-link {% if key == selected_period_key %}active{% endif %}"
                    href="#"
                    data-period-key="{{ key }}">
                    {{ period_data.label }}
                 </a></li>{% endfor %} </ul> </div> </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless small">
                        <thead> <tr class="text-muted"> <th>Título</th> <th class="text-end">Visualizações</th> </tr> </thead>
                        <tbody id="page-views-tbody"> {# ID adicionado #}
                            {% for page in page_views_data %} <tr> <td title="{{ page.title }}">{{ page.title|truncatechars:45 }}</td> <td class="text-end fw-medium">{{ page.views }}</td> </tr> {% empty %} <tr> <td colspan="2" class="text-center text-muted fst-italic py-3">Nenhum dado de visualização encontrado.</td> </tr> {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card border-0 shadow-sm" style="border-radius: 0.75rem;">
                 <div class="card-header bg-white border-0 pt-3 pb-0 px-3 d-flex justify-content-between align-items-center"> <h5 class="card-title fw-semibold mb-0 fs-6">Novos Visitantes vs Visitantes Habituais</h5> <div class="dropdown d-inline-block"> <button class="btn btn-sm btn-outline-secondary dropdown-toggle period-dropdown-button" type="button" id="visitorTypePeriodDropdown" data-bs-toggle="dropdown" aria-expanded="false"> Últimos 7 dias </button> <ul class="dropdown-menu" aria-labelledby="periodDropdown">
                    {% for key, period_data in allowed_periods.items %}
                      <li>
                        {# Links agora usam JS, href="#" e data-period-key #}
                        <a class="dropdown-item period-link {% if key == selected_period_key %}active{% endif %}"
                            href="#"
                            data-period-key="{{ key }}">
                            {{ period_data.label }}
                        </a>
                      </li>
                    {% endfor %}
                  </ul> </div> </div>
                 <div class="card-body py-5"> <div class= "mt-4 row text-center align-items-center">
                    <div class="col-6"
                        style="height:140px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <!-- conta inicial vem em data-count -->
                        <canvas id="newVisitorsDonut"
                                width="120" height="120"
                                style="max-width: 100%; max-height: 100%;"
                                data-count="{{ new_visitor_count }}"></canvas>
                        <p class="fw-bold mt-2 mb-0" id="newVisitorsPerc">{{ new_visitor_percentage|default:"--%" }}</p>
                        <small class="text-muted">Novos</small>
                    </div>
                    <div class="col-6"
                        style="height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <canvas id="returningVisitorsDonut"
                                width="120" height="120"
                                style="max-width: 100%; max-height: 100%;"
                                data-count="{{ returning_visitor_count }}"></canvas>
                        <p class="fw-bold mt-2 mb-0" id="returningVisitorsPerc">{{ returning_visitor_percentage|default:"--%" }}</p>
                        <small class="text-muted">Habituais</small>
                    </div>
                  </div> </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100" style="border-radius: 0.75rem;">
                        <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted" style="font-size: 0.9rem;">Média de páginas vistas</h6>
                            <i class="bi bi-file-earmark-text display-6 text-warning my-2"></i>
                            <h4 class="card-title fw-bold mt-2" id="avg-page-views-value">{{ media_paginas_vistas }}</h4> {# ID adicionado #}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                     <div class="card border-0 shadow-sm h-100" style="border-radius: 0.75rem;">
                        <div class="card-body text-center">
                             <h6 class="card-subtitle mb-2 text-muted" style="font-size: 0.9rem;">Taxa de Interação</h6>
                             <i class="bi bi-graph-up display-6 text-success my-2"></i>
                            <h4 class="card-title fw-bold mt-2" id="engagement-rate-value">{{ taxa_interacao }}</h4> {# ID adicionado #}
                        </div>
                    </div>
                </div>
                <div class="col-12">
                     <div class="card border-0 shadow-sm" style="border-radius: 0.75rem;">
                         <div class="card-header bg-white border-0 pt-3 pb-0 px-3 d-flex justify-content-between align-items-center"> <h5 class="card-title fw-semibold mb-0 fs-6">Utilizadores por País</h5> <div class="dropdown d-inline-block"><button class="btn btn-sm btn-outline-secondary dropdown-toggle period-dropdown-button" type="button" id="countryPeriodDropdown" data-bs-toggle="dropdown" aria-expanded="false">Últimos 7 dias</button><ul class="dropdown-menu" aria-labelledby="periodDropdown">
                            {% for key, period_data in allowed_periods.items %}
                              <li>
                                {# Links agora usam JS, href="#" e data-period-key #}
                                <a class="dropdown-item period-link {% if key == selected_period_key %}active{% endif %}"
                                    href="#"
                                    data-period-key="{{ key }}">
                                    {{ period_data.label }}
                                </a>
                              </li>
                            {% endfor %}
                          </ul></div> </div>
                         <div class="card-body"> <div class="row"> <div class="col-md-8"><div id="worldMapPlaceholder" style="height: 200px; background-color: #e9ecef; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem;" class="text-muted">Mapa Aqui</div></div> <div class="col-md-4"><table class="table table-sm table-borderless small mt-2 mt-md-0"><thead><tr class="text-muted"><th>País</th><th class="text-end">Utilizadores</th></tr></thead><tbody>{% for country in country_data|default_if_none:'' %}<tr><td><span class="badge bg-secondary">{{ country.code | default:"--"}}</span></td><td class="text-end fw-medium">{{ country.users | default:"--" }}</td></tr>{% empty %}<tr><td colspan="2" class="text-center text-muted fst-italic py-3">Sem dados.</td></tr>{% endfor %}</tbody></table></div> </div> </div>
                     </div>
                </div>
            </div>
        </div>
    </div>
</div> {# Fim container-fluid #}

{# Scripts de Dados para carga inicial #}
{{ labels|json_script:"labels-data" }}
{{ active_users|json_script:"ativos-data" }}
{{ events|json_script:"eventos-data" }}
{{ new_users|json_script:"novos-data" }}
{{ new_visitor_data|json_script:"new-visitor-data" }}
{{ returning_visitor_data|json_script:"returning-visitor-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    /* ──────────────── ESTADO GLOBAL ──────────────── */
    let chartLabels      = JSON.parse(document.getElementById("labels-data").textContent   || '[]');
    let chartDataAtivos  = JSON.parse(document.getElementById("ativos-data").textContent   || '[]');
    let chartDataEventos = JSON.parse(document.getElementById("eventos-data").textContent  || '[]');
    let chartDataNovos   = JSON.parse(document.getElementById("novos-data").textContent    || '[]');

    const ctx              = document.getElementById("mainLineChart")?.getContext("2d");
    const chartTitleEl     = document.getElementById("chartTitle");
    const allPeriodButtons = document.querySelectorAll('.period-dropdown-button');
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw(chart, _args, opts) {
            if (!opts?.text) return;                       // ignora se não houver texto
            const { ctx, chartArea: { width, height } } = chart;
            ctx.save();
            ctx.font         = '600 14px sans-serif';
            ctx.fillStyle    = '#212529';
            ctx.textAlign    = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(opts.text, width / 2, height / 2);
            ctx.restore();
        }
    };
    Chart.register(centerTextPlugin);

    window.chartInstance   = null;
    let currentChartType   = 'ativos';

    /* ──────────────── FUNÇÕES UTILITÁRIAS ──────────────── */
    const setButtonsText     = txt   => allPeriodButtons.forEach(btn => btn.textContent  = txt);
    const toggleButtonsState = state => allPeriodButtons.forEach(btn => btn.disabled     = state);

    const _updateChart = tipo => {
        if (!ctx) return;

        const styles = {
            ativos : {lbl: "Utilizadores Ativos", cor: "rgba(13,110,253)"},
            eventos: {lbl: "Eventos"            , cor: "rgba(255,193,7)"},
            novos  : {lbl: "Utilizadores Novos" , cor: "rgba(40,167,69)"}
        }[tipo];

        if (!styles) return;

        const datasets = {
            ativos : chartDataAtivos,
            eventos: chartDataEventos,
            novos  : chartDataNovos
        };

        const baseColor = styles.cor;
        const bgColor   = baseColor.replace(')', ',0.1)');
        const maxY      = Math.max(Math.max(...datasets[tipo], 0) + 2, 5);

        if (window.chartInstance) {
            const c = window.chartInstance;
            c.data.labels                     = chartLabels;
            c.data.datasets[0].label          = styles.lbl;
            c.data.datasets[0].data           = datasets[tipo];
            c.data.datasets[0].borderColor    = baseColor;
            c.data.datasets[0].backgroundColor= bgColor;
            c.data.datasets[0].pointBackgroundColor = baseColor;
            c.options.scales.y.suggestedMax   = maxY;
            c.update();
        } else {
            window.chartInstance = new Chart(ctx, {
                type : 'line',
                data : { labels: chartLabels,
                         datasets: [{
                             label               : styles.lbl,
                             data                : datasets[tipo],
                             borderColor         : baseColor,
                             backgroundColor     : bgColor,
                             tension             : 0.4, fill: true,
                             borderWidth         : 2,
                             pointRadius         : 3,
                             pointHoverRadius    : 6,
                             pointBackgroundColor: baseColor
                         }]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales : {
                        y: { beginAtZero: true, ticks: { precision: 0 }, suggestedMax: maxY },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
        chartTitleEl.textContent = styles.lbl;
    };

    window.showChart = tipo => {
        currentChartType = tipo;
        _updateChart(tipo);
    };

    /* ──────────────── RESIZE INIT (1ª render) ──────────────── */
    const canvas = document.getElementById("mainLineChart");
    if (canvas) {
        new ResizeObserver(entries => {
            if (entries[0].contentRect.width > 0) {
                window.showChart(currentChartType);
            }
        }).observe(canvas);
    }

    /* ── donuts Novos / Habituais ────────────────────────────────────────── */
let donutNew = null, donutRet = null;

function renderDonuts(newCount, retCount) {
    const total = (newCount + retCount) || 1;              // evita divisão por 0
    const newPerc = +(newCount / total * 100).toFixed(1);
    const retPerc = +(retCount / total * 100).toFixed(1);

    // actualiza legenda textual
    document.getElementById('newVisitorsPerc').textContent = `${newPerc}%`;
    document.getElementById('returningVisitorsPerc').textContent = `${retPerc}%`;

    const makeChart = (ctx, mainColour, perc, reverse = false) => new Chart(ctx, {
        type: 'doughnut',
        data: { 
        datasets: [{
            data: reverse ? [100 - perc, perc] : [perc, 100 - perc], // inverter valores!
            backgroundColor: reverse ? ['#e9ecef', mainColour] : [mainColour, '#e9ecef'],
            borderWidth: 0
        }]
    },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '68%',
            rotation: -Math.PI / 2, // começa no topo
            plugins: {
                legend:   { display: false },
                tooltip:  { enabled: false },
                centerText: { text: `${perc}%` }   // vem para o plugin
            }
        }
    });

    // destruir (se já existirem) e recriar
    donutNew?.destroy();
    donutRet?.destroy();
    donutNew = makeChart(
        document.getElementById('newVisitorsDonut').getContext('2d'),
        '#70B540', newPerc
    );
    donutRet = makeChart(
        document.getElementById('returningVisitorsDonut').getContext('2d'),
        '#6c757d', retPerc,
        true // inverter valores para o donut de habituais, para uma melhor estética
    );
}

// ── primeira renderização com valores vindos do template
renderDonuts(
    parseInt(document.getElementById('newVisitorsDonut').dataset.count)  || 0,
    parseInt(document.getElementById('returningVisitorsDonut').dataset.count) || 0
);


    /* ──────────────── EVENTO DE CADA LINK ──────────────── */
    document.querySelectorAll('.period-link').forEach(link => {
        link.addEventListener('click', ev => {
            ev.preventDefault();

            const periodKey   = link.dataset.periodKey;
            const periodLabel = link.textContent.trim();
            if (!periodKey)   return;

            setButtonsText('A carregar…');
            toggleButtonsState(true);

            fetch(`/api/data/?period=${periodKey}&chart=${currentChartType}`)
                .then(r => r.ok ? r.json() : r.json().then(j => {throw new Error(j.error || r.statusText);}))
                .then(data => {
                    /* ─── Estado ─── */
                    chartLabels      = data.labels       || [];
                    chartDataAtivos  = data.active_users || [];
                    chartDataEventos = data.events       || [];
                    chartDataNovos   = data.new_users    || [];

                    /* ─── Cartões superiores ─── */
                    document.getElementById('total-active-value').textContent  = data.total_active ?? '0';
                    document.getElementById('total-events-value').textContent  = data.total_events ?? '0';
                    document.getElementById('total-new-value').textContent     = data.total_new    ?? '0';

                    /* ─── Cartões inferiores ─── */
                    document.getElementById('avg-page-views-value').textContent = data.media_paginas_vistas ?? '0.00';
                    document.getElementById('engagement-rate-value').textContent = data.taxa_interacao       ?? '0.0%';

                    /* ─── Tabela de páginas ─── */
                    const tbody = document.getElementById('page-views-tbody');
                    tbody.innerHTML = '';
                    (data.page_views_data || []).forEach(p => {
                        const tr   = tbody.insertRow();
                        const cell1= tr.insertCell(), cell2 = tr.insertCell();
                        cell1.textContent        = p.title.length > 45 ? p.title.slice(0,42)+'…' : p.title;
                        cell1.title              = p.title;
                        cell2.textContent        = p.views;
                        cell2.className          = 'text-end fw-medium';
                    });
                    if (!data.page_views_data?.length)
                        tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted fst-italic py-3">Nenhum dado de visualização encontrado.</td></tr>';

                        /* ─── donuts ─── */
                    if (typeof data.new_visitor_count !== 'undefined' &&
                        typeof data.returning_visitor_count !== 'undefined') {
                        renderDonuts(data.new_visitor_count, data.returning_visitor_count);
                    }

                    /* ─── Gráfico principal ─── */
                    _updateChart(currentChartType);

                    /* ─── UI ─── */
                    setButtonsText(periodLabel);
                    document.querySelectorAll('.period-link').forEach(a => a.classList.toggle('active',
                        a.dataset.periodKey === periodKey));
                })
                .catch(err => {
                    console.error('Erro API:', err);
                    setButtonsText('Erro!');
                })
                .finally(() => toggleButtonsState(false));
        });
    });
});
</script>


{% endblock %}